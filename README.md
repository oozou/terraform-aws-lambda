# terraform-aws-lambda-edge

## Usage

```terraform
module "lambda" {
  source = "../"

  prefix      = "sbth"
  environment = "dev"
  name        = "sigv4-request-to-s3"

  # File to read from
  source_code_dir = "./src"
  file_globs      = ["index.js"]

  # File to saved to
  local_file_dir = "./outputs"

  # S3 to upload source code to
  is_create_lambda_bucket = true                 # Default is `false`; plz use false, if not 1 lambda: 1 bucket
  bucket_name             = "arn:aws:s3:::nanan" # If `is_create_lambda_bucket` is `false`; specified this, default is `""`

  # Lambda Config
  runtime = "nodejs12.x"
  handler = "index.handler" # Default `"index.handler"`

  # IAM
  is_create_lambda_role              = true                                               # Default is `true`
  lambda_role_arn                    = ""                                                 # If `is_create_lambda_role` is `false`
  additional_lambda_role_policy_arns = ["arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess"] # The policies that you want to attach to IAM Role created by only this module

  # Logging
  is_create_cloudwatch_log_group = true # Default is `true`
  retention_in_days              = 30   # Default is `30`

  # Secret for lambda function
  ssm_params = {
    "DATABASE_PASSWORD" = "abdhegcg2365daA"
    "DATABASE_HOST"     = "www.google.com"
  }

  tags = { "Workspace" = "pc" }
}

```

<!-- BEGIN_TF_DOCS -->
## Requirements

| Name                                                                      | Version  |
|---------------------------------------------------------------------------|----------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.0.0 |
| <a name="requirement_archive"></a> [archive](#requirement\_archive)       | 2.2.0    |
| <a name="requirement_aws"></a> [aws](#requirement\_aws)                   | >= 4.00  |

## Providers

| Name                                                          | Version |
|---------------------------------------------------------------|---------|
| <a name="provider_archive"></a> [archive](#provider\_archive) | 2.2.0   |
| <a name="provider_aws"></a> [aws](#provider\_aws)             | 4.13.0  |

## Modules

| Name                                       | Source                                    | Version |
|--------------------------------------------|-------------------------------------------|---------|
| <a name="module_s3"></a> [s3](#module\_s3) | git@github.com:oozou/terraform-aws-s3.git | v1.0.2  |

## Resources

| Name                                                                                                                                                           | Type        |
|----------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------|
| [aws_cloudwatch_log_group.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_log_group)                              | resource    |
| [aws_iam_policy.ssm_policy](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_policy)                                            | resource    |
| [aws_iam_role.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role)                                                      | resource    |
| [aws_iam_role_policy.logs_role_policy](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy)                            | resource    |
| [aws_iam_role_policy_attachment.ssm_policy_attachment](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy_attachment) | resource    |
| [aws_iam_role_policy_attachment.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy_attachment)                  | resource    |
| [aws_lambda_function.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_function)                                        | resource    |
| [aws_s3_object.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_object)                                                    | resource    |
| [aws_ssm_parameter.params](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ssm_parameter)                                          | resource    |
| [archive_file.zip_file](https://registry.terraform.io/providers/hashicorp/archive/2.2.0/docs/data-sources/file)                                                | data source |
| [aws_iam_policy_document.assume_role_policy_doc](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document)           | data source |
| [aws_iam_policy_document.lambda_logs_policy_doc](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document)           | data source |
| [aws_iam_policy_document.secret_access_policy_doc](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document)         | data source |

## Inputs

| Name                                                                                                                                             | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | Type           | Default           | Required |
|--------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------|-------------------|:--------:|
| <a name="input_additional_lambda_role_policy_arns"></a> [additional\_lambda\_role\_policy\_arns](#input\_additional\_lambda\_role\_policy\_arns) | List of policies ARNs to attach to the lambda                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `list(string)` | `[]`              |    no    |
| <a name="input_bucket_name"></a> [bucket\_name](#input\_bucket\_name)                                                                            | Name of the bucket to put the file in. Alternatively, an S3 access point ARN can be specified.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `string`       | `""`              |    no    |
| <a name="input_config_file_name"></a> [config\_file\_name](#input\_config\_file\_name)                                                           | The name of the file var.plaintext\_params will be written to as json                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `string`       | `"config.json"`   |    no    |
| <a name="input_environment"></a> [environment](#input\_environment)                                                                              | Environment Variable used as a prefix                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `string`       | n/a               |   yes    |
| <a name="input_file_globs"></a> [file\_globs](#input\_file\_globs)                                                                               | list of files or globs that you want included from the source\_code\_dir                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `list(string)` | n/a               |   yes    |
| <a name="input_handler"></a> [handler](#input\_handler)                                                                                          | Function entrypoint in your code.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `string`       | `"index.handler"` |    no    |
| <a name="input_is_create_cloudwatch_log_group"></a> [is\_create\_cloudwatch\_log\_group](#input\_is\_create\_cloudwatch\_log\_group)             | Whether to create cloudwatch log group or not                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `bool`         | `true`            |    no    |
| <a name="input_is_create_lambda_bucket"></a> [is\_create\_lambda\_bucket](#input\_is\_create\_lambda\_bucket)                                    | Whether to create lambda bucket or not                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | `bool`         | `false`           |    no    |
| <a name="input_local_file_dir"></a> [local\_file\_dir](#input\_local\_file\_dir)                                                                 | A path to the directory to store plan time generated local files                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `string`       | n/a               |   yes    |
| <a name="input_name"></a> [name](#input\_name)                                                                                                   | Name of the ECS cluster to create                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `string`       | n/a               |   yes    |
| <a name="input_plaintext_params"></a> [plaintext\_params](#input\_plaintext\_params)                                                             | Lambda@Edge does not support env vars, so it is a common pattern to exchange Env vars for values read from a config file.<br><br>  So instead of using env vars like:<br>  `const someEnvValue = process.env.SOME_ENV`<br><br>  you would have lookups from a config file:<pre>const config = JSON.parse(readFileSync('./config.json'))<br>  const someConfigValue = config.SomeKey</pre>Compared to var.ssm\_params, you should use this variable when you have non-secret things that you want very quick access<br>  to during the execution of your lambda function.                                                                                                                                                                                                                                                                                                                                                                              | `map(string)`  | `{}`              |    no    |
| <a name="input_prefix"></a> [prefix](#input\_prefix)                                                                                             | The prefix name of customer to be displayed in AWS console and resource                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `string`       | n/a               |   yes    |
| <a name="input_retention_in_days"></a> [retention\_in\_days](#input\_retention\_in\_days)                                                        | Retention day for cloudwatch log group                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | `number`       | `30`              |    no    |
| <a name="input_runtime"></a> [runtime](#input\_runtime)                                                                                          | The runtime of the lambda function                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `string`       | n/a               |   yes    |
| <a name="input_source_code_dir"></a> [source\_code\_dir](#input\_source\_code\_dir)                                                              | An absolute path to the directory containing the code to upload to lambda                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `string`       | n/a               |   yes    |
| <a name="input_ssm_params"></a> [ssm\_params](#input\_ssm\_params)                                                                               | Lambda@Edge does not support env vars, so it is a common pattern to exchange Env vars for SSM params.<br><br>  So instead of using env vars like:<br>  `const someEnvValue = process.env.SOME_ENV`<br><br>  you would have lookups in SSM, like:<br>  `const someEnvValue = await ssmClient.getParameter({ Name: 'SOME_SSM_PARAM_NAME', WithDecryption: true })`<br><br>  These params should have names that are unique within an AWS account, so it is a good idea to use a common<br>  prefix in front of the param names, such as:<pre>params = {<br>    COMMON_PREFIX_REGION = "eu-west-1"<br>    COMMON_PREFIX_NAME   = "Joeseph Schreibvogel"<br>  }</pre>Compared to var.plaintext\_params, you should use this variable when you have secret data that you don't want written in plaintext in a file<br>  in your lambda .zip file. These params will need to be fetched via a Promise at runtime, so there may be small performance delays. | `map(string)`  | `{}`              |    no    |
| <a name="input_tags"></a> [tags](#input\_tags)                                                                                                   | Custom tags which can be passed on to the AWS resources. They should be key value pairs having distinct keys                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `map(any)`     | `{}`              |    no    |

## Outputs

| Name                                                                                              | Description                                                  |
|---------------------------------------------------------------------------------------------------|--------------------------------------------------------------|
| <a name="output_arn"></a> [arn](#output\_arn)                                                     | Amazon Resource Name (ARN) identifying your Lambda Function. |
| <a name="output_execution_role_arn"></a> [execution\_role\_arn](#output\_execution\_role\_arn)    | n/a                                                          |
| <a name="output_execution_role_name"></a> [execution\_role\_name](#output\_execution\_role\_name) | n/a                                                          |
| <a name="output_function_arn"></a> [function\_arn](#output\_function\_arn)                        | n/a                                                          |
| <a name="output_function_name"></a> [function\_name](#output\_function\_name)                     | Name of AWS Lambda function                                  |
<!-- END_TF_DOCS -->
